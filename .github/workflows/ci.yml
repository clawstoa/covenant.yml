name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify static badge catalog assets
        run: |
          set -euo pipefail
          expected=(
            docs/badges/covenant/covenant-enabled.svg
            docs/badges/agent-pr-policy/allow.svg
            docs/badges/agent-pr-policy/warn.svg
            docs/badges/agent-pr-policy/deny.svg
            docs/badges/agent-pr-policy/none.svg
            docs/badges/provenance-policy/required.svg
            docs/badges/provenance-policy/configured.svg
            docs/badges/provenance-policy/none.svg
            docs/badges/attestation-required/required.svg
            docs/badges/attestation-required/agents.svg
            docs/badges/attestation-required/none.svg
            docs/badges/thread-intervention-policy/controlled.svg
            docs/badges/thread-intervention-policy/open.svg
          )
          for path in "${expected[@]}"; do
            if [[ ! -f "$path" ]]; then
              echo "Missing badge asset: $path"
              exit 1
            fi
          done
          count="$(find docs/badges -type f -name '*.svg' | wc -l | tr -d ' ')"
          if [[ "$count" != "13" ]]; then
            echo "Expected 13 SVG badge files under docs/badges, found $count"
            exit 1
          fi
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - run: pnpm install --frozen-lockfile
      - run: pnpm test
      - run: node bin/covenant.js validate covenant.yml
      - name: Build simulator bundle
        run: node scripts/build-site-simulator.mjs

  badges:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Generate badge descriptors
        run: node bin/covenant.js badge --policy covenant.yml --format shields > badges.json
      - uses: actions/upload-artifact@v4
        with:
          name: covenant-badges
          path: badges.json
